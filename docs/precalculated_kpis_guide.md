# Pre-Calculated KPIs Guide
## CryptoRisk Analytics - Simplified Semantic Layer

This guide explains how to use the pre-calculated KPI tables generated by `prepare_crypto_data_with_kpis.py`.

---

## üéØ Why Pre-Calculated KPIs?

**Problem**: Complex LOD expressions and table calculations in Tableau Data Cloud semantic layer caused issues:
- Volatility measures returned empty values
- VaR calculations were summing across all dates (millions instead of thousands)
- Sharpe Ratios showed negative values due to improper aggregation
- Required complex date filtering and table calculation configuration

**Solution**: Pre-calculate all KPIs at the correct level of detail in Python, then simply reference them in the semantic layer using basic SUM/AVG aggregations.

---

## üìä Generated KPI Tables

### 1. `kpi_portfolio_volatility_timeseries.csv`

**Purpose**: Rolling volatility calculations for each portfolio for every date.

**Fields**:
- `portfolio_id` (String): Portfolio identifier (PF001, PF002, PF003)
- `portfolio_name` (String): Portfolio name
- `date` (Date): Date of calculation
- `volatility_30d` (Decimal): 30-day annualized volatility (NULL for first 29 days)
- `volatility_90d` (Decimal): 90-day annualized volatility (NULL for first 89 days)
- `volatility_365d` (Decimal): 365-day annualized volatility (NULL for first 364 days)
- `downside_volatility_365d` (Decimal): 365-day downside volatility (for Sortino Ratio)

**Records**: 11,038 (3 portfolios √ó ~3,679 dates)

**Usage in Semantic Layer**:
```yaml
- name: "Portfolio Volatility (30d)"
  source_field: "dmo_kpi_volatility.volatility_30d"
  aggregation: "average"  # or use MAX for latest value
  data_type: "decimal"
  format: "percentage"
  precision: 2
```

**No filters needed!** Just drag and drop. Values automatically populate for each date/portfolio.

---

### 2. `kpi_portfolio_var_current.csv`

**Purpose**: Value at Risk calculations using CURRENT (latest) portfolio positions.

**Fields**:
- `portfolio_id` (String): Portfolio identifier
- `portfolio_name` (String): Portfolio name
- `as_of_date` (Date): Date of calculation (2026-01-09)
- `portfolio_value` (Decimal): Total portfolio value
- `var_95` (Decimal): VaR at 95% confidence (dollar amount, negative)
- `var_99` (Decimal): VaR at 99% confidence (dollar amount, negative)
- `var_95_pct` (Decimal): VaR 95% as percentage
- `var_99_pct` (Decimal): VaR 99% as percentage

**Records**: 3 (one per portfolio)

**Actual Values**:
- Conservative Growth ($96,550): VaR 95% = **-$5,055** (5.2%)
- Balanced Portfolio ($252,852): VaR 95% = **-$11,829** (4.7%)
- High Growth ($399,918): VaR 95% = **-$23,403** (5.9%)

**Usage in Semantic Layer**:
```yaml
- name: "VaR 95%"
  source_field: "dmo_kpi_var.var_95"
  aggregation: "sum"  # Since there's only one record per portfolio
  data_type: "decimal"
  format: "currency"
  precision: 2
```

**‚úÖ Values are correct**: Thousands (not millions), VaR 95% ‚â† VaR 99%

---

### 3. `kpi_portfolio_risk_adjusted_returns.csv`

**Purpose**: Sharpe, Sortino, Beta, Alpha, and Correlation calculations.

**Fields**:
- `portfolio_id` (String): Portfolio identifier
- `portfolio_name` (String): Portfolio name
- `as_of_date` (Date): Date of calculation
- `portfolio_value` (Decimal): Total portfolio value
- `cost_basis` (Decimal): Total cost basis
- `portfolio_return_annualized` (Decimal): Annualized return
- `sharpe_ratio` (Decimal): Risk-adjusted return (Sharpe)
- `sortino_ratio` (Decimal): Downside risk-adjusted return (Sortino)
- `beta_vs_btc` (Decimal): Portfolio sensitivity to BTC
- `alpha` (Decimal): Excess return vs BTC
- `correlation_to_btc` (Decimal): Correlation coefficient with BTC

**Records**: 3 (one per portfolio)

**Actual Values**:
| Portfolio | Sharpe | Beta | Alpha | Correlation |
|-----------|--------|------|-------|-------------|
| Conservative Growth | **0.19** | 0.86 | -51.8% | 0.91 |
| Balanced Portfolio | **0.02** | 0.74 | -51.1% | 0.83 |
| High Growth | **0.04** | 0.76 | -35.3% | 0.67 |

**Usage in Semantic Layer**:
```yaml
- name: "Sharpe Ratio"
  source_field: "dmo_kpi_risk_adj.sharpe_ratio"
  aggregation: "average"
  data_type: "decimal"
  format: "number"
  precision: 2
```

**‚úÖ Values are positive and reasonable** (no more -97!)

---

### 4. `kpi_portfolio_concentration.csv`

**Purpose**: Position-level weights, HHI, and portfolio concentration metrics.

**Fields**:
- `portfolio_id` (String): Portfolio identifier
- `portfolio_name` (String): Portfolio name
- `as_of_date` (Date): Date of calculation
- `symbol` (String): Cryptocurrency symbol
- `position_value` (Decimal): Position value in dollars
- `position_weight` (Decimal): Actual weight (0-1)
- `target_weight` (Decimal): Target allocation weight
- `weight_drift` (Decimal): Difference from target
- `is_overweight` (Boolean): TRUE if > 10% above target
- `is_underweight` (Boolean): TRUE if > 10% below target
- `portfolio_hhi` (Decimal): Herfindahl Index (concentration measure)
- `portfolio_liquid_assets_pct` (Decimal): % in liquid assets

**Records**: 15 (3 portfolios √ó 4-7 positions each)

**Actual Values**:
- Conservative Growth: HHI = **0.359** (Concentrated - 50% BTC)
- Balanced Portfolio: HHI = **0.231** (Moderate)
- High Growth: HHI = **0.227** (Well diversified)

**Usage in Semantic Layer**:
```yaml
- name: "Position Weight %"
  source_field: "dmo_kpi_concentration.position_weight"
  aggregation: "average"
  data_type: "decimal"
  format: "percentage"
  precision: 2

- name: "Portfolio HHI"
  source_field: "dmo_kpi_concentration.portfolio_hhi"
  aggregation: "average"  # Same for all positions in portfolio
  data_type: "decimal"
  format: "number"
  precision: 4
```

---

### 5. `kpi_portfolio_24h_change.csv`

**Purpose**: Daily portfolio value changes (24-hour performance).

**Fields**:
- `portfolio_id` (String): Portfolio identifier
- `portfolio_name` (String): Portfolio name
- `date` (Date): Date of calculation
- `portfolio_value` (Decimal): Portfolio value on this date
- `change_24h` (Decimal): Dollar change from previous day
- `change_24h_pct` (Decimal): Percentage change from previous day

**Records**: 1,092 (3 portfolios √ó 364 days with change data)

**Usage in Semantic Layer**:
```yaml
- name: "Portfolio 24h Change %"
  source_field: "dmo_kpi_24h_change.change_24h_pct"
  aggregation: "average"
  data_type: "decimal"
  format: "percentage"
  precision: 1
```

**Usage in Dashboard**: Filter to `date = MAX(date)` to show latest 24h change.

---

## üîß Data Cloud Setup

### Step 1: Upload CSV Files

Upload these 5 new CSV files to Tableau Data Cloud:
1. `kpi_portfolio_volatility_timeseries.csv`
2. `kpi_portfolio_var_current.csv`
3. `kpi_portfolio_risk_adjusted_returns.csv`
4. `kpi_portfolio_concentration.csv`
5. `kpi_portfolio_24h_change.csv`

### Step 2: Create DMOs

Create 5 new Data Model Objects (DMOs):

#### DMO: dmo_kpi_volatility
- **Source**: kpi_portfolio_volatility_timeseries.csv
- **Primary Key**: `portfolio_id` + `date`
- **Relationships**: 
  - ‚Üí `dmo_portfolio_positions` via `portfolio_id`
  - ‚Üí `dmo_crypto_prices` via `date`

#### DMO: dmo_kpi_var
- **Source**: kpi_portfolio_var_current.csv
- **Primary Key**: `portfolio_id`
- **Relationships**: 
  - ‚Üí `dmo_portfolio_positions` via `portfolio_id`

#### DMO: dmo_kpi_risk_adjusted
- **Source**: kpi_portfolio_risk_adjusted_returns.csv
- **Primary Key**: `portfolio_id`
- **Relationships**: 
  - ‚Üí `dmo_portfolio_positions` via `portfolio_id`

#### DMO: dmo_kpi_concentration
- **Source**: kpi_portfolio_concentration.csv
- **Primary Key**: `portfolio_id` + `symbol`
- **Relationships**: 
  - ‚Üí `dmo_portfolio_positions` via `portfolio_id` + `symbol`
  - ‚Üí `dmo_cryptocurrency` via `symbol`

#### DMO: dmo_kpi_24h_change
- **Source**: kpi_portfolio_24h_change.csv
- **Primary Key**: `portfolio_id` + `date`
- **Relationships**: 
  - ‚Üí `dmo_portfolio_positions` via `portfolio_id`

### Step 3: Update Semantic Layer

Replace complex formulas with simple field references:

**BEFORE** (Complex LOD):
```yaml
- name: "Portfolio Volatility (30d)"
  formula: "{ FIXED [Portfolio ID] : STDEV([dmo_crypto_prices].[Daily Return %]) } * (365^0.5)"
  # Required date filter to Last 30 days!
```

**AFTER** (Simple field reference):
```yaml
- name: "Portfolio Volatility (30d)"
  source_field: "dmo_kpi_volatility.volatility_30d"
  aggregation: "average"
  data_type: "decimal"
  format: "percentage"
  precision: 2
  # No filters needed!
```

---

## ‚úÖ Benefits

### Before (LOD Expressions)
- ‚ùå Volatility returned empty values
- ‚ùå VaR showed millions instead of thousands
- ‚ùå Sharpe Ratio was -97 instead of 0.19
- ‚ùå Required complex date filters
- ‚ùå Required table calculation configuration
- ‚ùå Users had to understand LOD expressions

### After (Pre-Calculated)
- ‚úÖ All values populate correctly
- ‚úÖ VaR shows thousands (-$5K to -$23K)
- ‚úÖ Sharpe Ratio shows positive values (0.02 to 0.19)
- ‚úÖ No filters needed (except for "latest" views)
- ‚úÖ Simple SUM/AVG aggregations
- ‚úÖ Users just drag and drop

---

## üìã Testing Checklist

- [ ] Upload 5 KPI CSV files to Data Cloud
- [ ] Create 5 DMOs
- [ ] Set up relationships
- [ ] Update semantic layer with simple field references
- [ ] Test Volatility (30d): Should show 15-50%
- [ ] Test VaR 95%: Should show -$5K to -$23K (not millions)
- [ ] Test Sharpe Ratio: Should show 0.02 to 0.19 (not negative)
- [ ] Test Position Weight %: Should sum to 100% per portfolio
- [ ] Test 24h Change: Should show daily fluctuations

---

## üîÑ Regenerating KPIs

If you update the source data (`crypto_prices_daily_2020_2024.csv` or `portfolio_positions_current.csv`), regenerate KPIs:

```bash
cd "/Users/shenry/Documents/Personal/Training/Project/Tableau Next Hackathon"

# Step 1: Regenerate source data (optional)
python3 scripts/prepare_crypto_data.py

# Step 2: Regenerate KPI tables
python3 scripts/prepare_crypto_data_with_kpis.py

# Step 3: Re-upload KPI CSV files to Data Cloud
```

---

## üí° Pro Tips

1. **Latest Values**: For dashboard KPI cards showing "current" values, filter to `MAX(date)` or `as_of_date = '2026-01-09'`

2. **Time Series**: For volatility trends over time, use `dmo_kpi_volatility` with Date on axis

3. **Portfolio Comparison**: All KPI tables include `portfolio_name`, making cross-portfolio analysis easy

4. **Missing Values**: Early dates have NULL volatility (need 30/90/365 days of history). This is expected and correct.

5. **Performance**: Pre-calculated KPIs query much faster than LOD expressions!

---

## üìä Quick Reference

| KPI | Table | Field | Aggregation | Expected Range |
|-----|-------|-------|-------------|----------------|
| Volatility 30d | dmo_kpi_volatility | volatility_30d | AVG | 15-50% |
| Volatility 90d | dmo_kpi_volatility | volatility_90d | AVG | 15-45% |
| Volatility 365d | dmo_kpi_volatility | volatility_365d | AVG | 20-40% |
| VaR 95% | dmo_kpi_var | var_95 | SUM | -$5K to -$23K |
| VaR 99% | dmo_kpi_var | var_99 | SUM | -$10K to -$42K |
| Sharpe Ratio | dmo_kpi_risk_adj | sharpe_ratio | AVG | 0.02 to 0.19 |
| Sortino Ratio | dmo_kpi_risk_adj | sortino_ratio | AVG | 0.03 to 0.28 |
| Beta vs BTC | dmo_kpi_risk_adj | beta_vs_btc | AVG | 0.74 to 0.86 |
| Alpha | dmo_kpi_risk_adj | alpha | AVG | -51% to -35% |
| Position Weight % | dmo_kpi_concentration | position_weight | AVG | 0-100% |
| Portfolio HHI | dmo_kpi_concentration | portfolio_hhi | AVG | 0.23 to 0.36 |
| Liquid Assets % | dmo_kpi_concentration | portfolio_liquid_assets_pct | AVG | 57% to 100% |
| 24h Change % | dmo_kpi_24h_change | change_24h_pct | AVG | -5% to +5% |

---

**‚úÖ Result**: Simple, reliable KPIs that work perfectly in Tableau Data Cloud semantic layer!
