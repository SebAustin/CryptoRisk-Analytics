# CryptoRisk Analytics - Data Cloud Setup Guide

Complete step-by-step guide to configure Salesforce Data Cloud for the CryptoRisk Analytics platform.

---

## Table of Contents

- [Phase 1: Prerequisites](#phase-1-prerequisites)
- [Phase 2: Data Streams Setup](#phase-2-data-streams-setup)
- [Phase 3: Data Lake Objects (DLOs)](#phase-3-data-lake-objects-dlos)
- [Phase 4: Data Model Objects (DMOs)](#phase-4-data-model-objects-dmos)
- [Phase 5: Relationships](#phase-5-relationships)
- [Phase 6: Calculated Fields](#phase-6-calculated-fields)
- [Phase 7: Validation](#phase-7-validation)

---

## Quick Reference: Primary Keys

All DMOs have properly defined primary keys to ensure data integrity:

| DMO / DLO | Primary Key | Type |
|-----------|-------------|------|
| `dmo_cryptocurrency` / `dlo_crypto_reference` | `symbol` | Single |
| `dmo_crypto_prices` / `dlo_crypto_prices` | `symbol` + `date` | Composite |
| `dmo_portfolio_positions` / `dlo_portfolio_positions` | `portfolio_id` + `symbol` + `as_of_date` | Composite |
| `dmo_trades` / `dlo_trades` | `trade_id` | Single |
| `dmo_market_metrics` / `dlo_market_metrics` | `date` | Single |
| `dmo_correlation_matrix` / `dlo_correlation_matrix` | `crypto1` + `crypto2` | Composite |
| `dmo_kpi_volatility` / `dlo_kpi_volatility` | `portfolio_id` + `date` | Composite |
| `dmo_kpi_var` / `dlo_kpi_var` | `portfolio_id` + `as_of_date` | Composite |
| `dmo_kpi_risk_adjusted` / `dlo_kpi_risk_adjusted` | `portfolio_id` + `as_of_date` | Composite |
| `dmo_kpi_concentration` / `dlo_kpi_concentration` | `portfolio_id` + `as_of_date` + `symbol` | Composite |
| `dmo_kpi_24h_change` / `dlo_kpi_24h_change` | `portfolio_id` + `date` | Composite |

**Important**: When creating Data Streams and DLOs, Tableau Data Cloud will automatically detect and suggest primary keys based on field names and data patterns. Always verify and configure the primary key during DLO setup to ensure referential integrity and optimal query performance.

---

## Phase 1: Prerequisites

### Required Permissions

- Salesforce Data Cloud Administrator
- Tableau Next enabled in your org
- Access to upload CSV files (< 100MB each)

### Data Files Location

All clean CSV files are in: `/data/raw/`

**Core Data Files**:
1. `crypto_reference.csv` (25 records)
2. `crypto_prices_daily_2020_2024.csv` (66,291 records)
3. `portfolio_positions_current.csv` (5,647 records)
4. `trades_history_sample.csv` (1,972,215 records)
5. `market_metrics_daily.csv` (4,018 records)

**Pre-Calculated KPI Files** (generated by `prepare_crypto_data_with_kpis.py`):
6. `kpi_portfolio_volatility_timeseries.csv` (11,038 records)
7. `kpi_portfolio_var_current.csv` (3 records)
8. `kpi_portfolio_risk_adjusted_returns.csv` (3 records)
9. `kpi_portfolio_concentration.csv` (15 records)
10. `kpi_portfolio_24h_change.csv` (1,092 records)

**Note**: Pre-calculated KPI files eliminate the need for complex LOD expressions in the semantic layer!

---

## Phase 2: Data Streams Setup

Navigate to: **Data Cloud → Data Streams → New → Upload File**

### Data Stream 1: Crypto Reference

**Settings**:
- Name: `ds_crypto_reference`
- Description: "Cryptocurrency reference data - symbols, names, categories"
- Source File: `crypto_reference.csv`

**Field Mappings**:
```
CSV Column          → DLO Field Name      Type         Notes
───────────────────────────────────────────────────────────────
symbol              → symbol             Text(10)     Primary key
name                → name               Text         
category            → category           Text         
launch_year         → launch_year        Number       
is_stablecoin       → is_stablecoin      Boolean      
is_active           → is_active          Boolean      
```

---

### Data Stream 2: Crypto Prices Daily

**Settings**:
- Name: `ds_crypto_prices`
- Description: "Daily OHLCV price data for all cryptocurrencies (2020-2024)"
- Source File: `crypto_prices_daily_2020_2024.csv`

**Field Mappings**:
```
CSV Column          → DLO Field Name      Type         Notes
───────────────────────────────────────────────────────────────
date                → date               Date         Composite primary key (1/2)
symbol              → symbol             Text(10)     Composite primary key (2/2)
open                → open               Number(8)    Decimal places
high                → high               Number(8)    
low                 → low                Number(8)    
close               → close              Number(8)    
volume              → volume             Number       
daily_return        → daily_return       Number       Percentage
ma_7                → ma_7               Number(8)    7-day MA
ma_30               → ma_30              Number(8)    30-day MA
volatility_30d      → volatility_30d     Number       Annualized
bb_middle           → bb_middle          Number(8)    Bollinger Band (20-day SMA)
bb_upper            → bb_upper           Number(8)    Upper Band (+2 std dev)
bb_lower            → bb_lower           Number(8)    Lower Band (-2 std dev)
bb_bandwidth        → bb_bandwidth       Number(8)    Band width % (volatility)
bb_percent          → bb_percent         Number(8)    %B (position in bands)
name                → crypto_name        Text         From enrichment
category            → category           Text         From enrichment
year                → year               Number       
month               → month              Number       
quarter             → quarter            Number       
day_of_week         → day_of_week        Text         
is_weekend          → is_weekend         Boolean      
```

**Data Quality Rules**:
- `close` must be > 0
- `volume` must be >= 0
- `date` must be between 2020-01-01 and 2024-12-31
- **Primary Key Constraint**: No duplicate `symbol` + `date` combinations (enforced - one price record per crypto per day)
- `daily_return` should be between -1 and 10 (handled in Python)

---

### Data Stream 3: Portfolio Positions

**Settings**:
- Name: `ds_portfolio_positions`
- Description: "Current portfolio holdings and positions"
- Source File: `portfolio_positions_current.csv`

**Field Mappings**:
```
CSV Column           → DLO Field Name         Type         Notes
──────────────────────────────────────────────────────────────────
portfolio_id         → portfolio_id          Text(10)     Composite PK (1/3)
portfolio_name       → portfolio_name        Text         
risk_tolerance       → risk_tolerance        Text         Low/Medium/High
symbol               → symbol                Text(10)     Composite PK (2/3)
quantity             → quantity              Number(8)    
avg_cost             → avg_cost              Number(8)    
current_price        → current_price         Number(8)    
position_value       → position_value        Number       
target_weight        → target_weight         Number       Decimal 0-1
as_of_date           → as_of_date            Date         Composite PK (3/3)
unrealized_pnl       → unrealized_pnl        Number       
unrealized_pnl_pct   → unrealized_pnl_pct    Number       Percentage
```

**Data Quality Rules**:
- **Primary Key Constraint**: No duplicate `portfolio_id` + `symbol` + `as_of_date` combinations
- `quantity` must be > 0
- `position_value` must be >= 0
- `symbol` must exist in crypto_reference
- `target_weight` should sum to ~1.0 per portfolio (per as_of_date)

---

### Data Stream 4: Trades History

**Settings**:
- Name: `ds_trades`
- Description: "Historical trade transactions for all portfolios"
- Source File: `trades_history_sample.csv`

**Field Mappings**:
```
CSV Column           → DLO Field Name         Type         Notes
──────────────────────────────────────────────────────────────────
trade_id             → trade_id              Text(20)     Primary key
trade_date           → trade_date            DateTime     
portfolio_id         → portfolio_id          Text(10)     Foreign key
portfolio_name       → portfolio_name        Text         
symbol               → symbol                Text(10)     Foreign key
trade_type           → trade_type            Text         BUY/SELL
quantity             → quantity              Number(8)    
price                → price                 Number(8)    
trade_amount         → trade_amount          Number       
fee                  → fee                   Number       
exchange             → exchange              Text         
order_type           → order_type            Text         Market/Limit
```

**Data Quality Rules**:
- `trade_date` must be <= today
- `quantity` must be > 0
- `price` must be > 0
- `trade_type` must be 'BUY' or 'SELL'
- `fee` must be >= 0

---

### Data Stream 5: Market Metrics

**Settings**:
- Name: `ds_market_metrics`
- Description: "Daily market-wide metrics and indicators"
- Source File: `market_metrics_daily.csv`

**Field Mappings**:
```
CSV Column           → DLO Field Name         Type         Notes
──────────────────────────────────────────────────────────────────
date                 → date                  Date         Primary key
total_volume         → total_volume          Number       Aggregated
avg_return           → avg_return            Number       Percentage
market_volatility    → market_volatility     Number       
btc_dominance_pct    → btc_dominance_pct     Number       Percentage
positive_movers      → positive_movers       Number       Count
negative_movers      → negative_movers       Number       Count
total_assets         → total_assets          Number       Count
volatility_30d       → volatility_30d        Number       Rolling
volume_ma_7          → volume_ma_7           Number       Rolling
```

---

### Data Stream 6: Correlation Matrix

**Settings**:
- Name: `ds_correlation_matrix`
- Description: "Pairwise correlation matrix between cryptocurrency returns (365-day rolling)"
- Source File: `correlation_matrix.csv`

**Field Mappings**:
```
CSV Column              → DLO Field Name         Type         Notes
──────────────────────────────────────────────────────────────────────
crypto1                 → crypto1               Text(10)     First crypto in pair (composite PK 1/2)
crypto2                 → crypto2               Text(10)     Second crypto in pair (composite PK 2/2)
correlation             → correlation           Number       Pearson correlation (-1 to 1)
is_self_correlation     → is_self_correlation   Boolean      True if crypto1 = crypto2 (always 1.0)
period_days             → period_days           Number       Lookback period (365 days)
period_start            → period_start          Date         Start of correlation period
period_end              → period_end            Date         End of correlation period
correlation_strength    → correlation_strength  Text         Category: Perfect/Very Strong/Strong/Moderate/Weak/Very Weak
correlation_direction   → correlation_direction Text         Positive/Negative/Neutral
```

**Data Quality Rules**:
- **Primary Key Constraint**: No duplicate `crypto1` + `crypto2` combinations
- `correlation` must be between -1 and 1
- Self-correlations (crypto1 = crypto2) should always equal 1.0
- Matrix should be symmetric: corr(A, B) = corr(B, A)

---

## Phase 3: Data Lake Objects (DLOs)

Each Data Stream auto-creates a DLO. Review and configure:

### DLO Configuration Checklist

For each DLO:
1. ✓ Verify field mappings are correct
2. ✓ Set primary key field(s)
3. ✓ Configure data retention (365 days minimum)
4. ✓ Enable refresh schedule (daily for demo)

**DLO List**:
- `dlo_crypto_reference` (Primary Key: `symbol`)
- `dlo_crypto_prices` (Primary Key: `symbol` + `date`)
- `dlo_portfolio_positions` (Primary Key: `portfolio_id` + `symbol` + `as_of_date`)
- `dlo_trades` (Primary Key: `trade_id`)
- `dlo_market_metrics` (Primary Key: `date`)
- `dlo_correlation_matrix` (Primary Key: `crypto1` + `crypto2`)
- `dlo_kpi_volatility` (Primary Key: `portfolio_id` + `date`)
- `dlo_kpi_var` (Primary Key: `portfolio_id` + `as_of_date`)
- `dlo_kpi_risk_adjusted` (Primary Key: `portfolio_id` + `as_of_date`)
- `dlo_kpi_concentration` (Primary Key: `portfolio_id` + `as_of_date` + `symbol`)
- `dlo_kpi_24h_change` (Primary Key: `portfolio_id` + `date`)

---

## Phase 4: Data Model Objects (DMOs)

Create 11 DMOs: 1 Dimension + 10 Facts (5 Core + 5 Pre-calculated KPIs + 1 Correlation Matrix)

### Dimension DMO

#### DMO 1: dmo_cryptocurrency (Dimension)

**Navigation**: Data Cloud → Data Model → New DMO → Dimension

**Settings**:
- Name: `dmo_cryptocurrency`
- Label: "Cryptocurrency"
- Description: "Cryptocurrency metadata and reference data"
- Type: Dimension

**Source**: `dlo_crypto_reference`

**Fields**:
```
Field Name          Source Field         Type        Primary Key   Description
──────────────────────────────────────────────────────────────────────────────────────────────────
symbol              symbol              Text        ✓             Cryptocurrency ticker symbol (e.g., BTC, ETH)
name                name                Text                      Full cryptocurrency name (e.g., Bitcoin, Ethereum)
category            category            Text                      Asset category: Layer 1, Layer 2, DeFi, Exchange Token, etc.
launch_year         launch_year         Number                    Year the cryptocurrency was launched/created
is_stablecoin       is_stablecoin       Boolean                   True if asset is a stablecoin (pegged to USD/fiat)
is_active           is_active           Boolean                   True if asset is actively traded and supported
```

**Calculated Fields**:
```sql
-- Market cap tier: Categorizes cryptocurrencies by market capitalization size
-- Used for portfolio diversification analysis and risk segmentation
market_cap_tier = 
  CASE 
    WHEN category IN ('Layer 1', 'Payment') THEN 'Large Cap'
    WHEN category IN ('Layer 2', 'DeFi', 'Exchange Token') THEN 'Mid Cap'
    ELSE 'Small Cap'
  END
```

---

### Fact DMOs

#### DMO 2: dmo_crypto_prices (Fact)

**Settings**:
- Name: `dmo_crypto_prices`
- Label: "Crypto Prices"
- Description: "Daily cryptocurrency price data (OHLCV) with date attributes"
- Type: Fact

**Source**: `dlo_crypto_prices`

**Fields**:
```
Field Name          Source Field         Type        Primary Key   Aggregation   Description
───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
date                date                Date        ✓             -             Trading date (YYYY-MM-DD) - Composite PK with symbol
symbol              symbol              Text        ✓             -             Cryptocurrency ticker symbol - Composite PK with date
open                open                Number                  AVG           Opening price in USD at start of trading day
high                high                Number                  MAX           Highest price in USD during trading day
low                 low                 Number                  MIN           Lowest price in USD during trading day
close               close               Number                  AVG           Closing price in USD at end of trading day
volume              volume              Number                  SUM           Total trading volume in USD for the day
daily_return        daily_return        Number                  AVG           Daily percentage return: (close - previous_close) / previous_close
ma_7                ma_7                Number                  AVG           7-day simple moving average of closing price
ma_30               ma_30               Number                  AVG           30-day simple moving average of closing price
volatility_30d      volatility_30d      Number                  AVG           30-day rolling volatility, annualized (sqrt(252) * std(returns))
bb_middle           bb_middle           Number                  AVG           Bollinger Band middle line (20-day SMA of close price)
bb_upper            bb_upper            Number                  AVG           Bollinger Band upper limit (middle + 2 × std dev)
bb_lower            bb_lower            Number                  AVG           Bollinger Band lower limit (middle - 2 × std dev)
bb_bandwidth        bb_bandwidth        Number                  AVG           Bollinger Band width percentage: (upper - lower) / middle × 100 - volatility indicator
bb_percent          bb_percent          Number                  AVG           %B: Position within bands (close - lower) / (upper - lower) - overbought/oversold indicator
year                year                Number                  -             Year extracted from date (e.g., 2024)
month               month               Number                  -             Month number (1-12)
quarter             quarter             Number      -             Quarter number (1-4)
day_of_week         day_of_week         Text        -             Day name (Monday-Sunday)
is_weekend          is_weekend          Boolean     -             True if Saturday or Sunday
```

**Measures** (pre-aggregate):
- `total_volume`: SUM(volume) - Total trading volume across all cryptos/dates in USD
- `avg_close_price`: AVG(close) - Average closing price, useful for aggregating across multiple days
- `max_high`: MAX(high) - Maximum high price in the selected period
- `min_low`: MIN(low) - Minimum low price in the selected period
- `avg_daily_return`: AVG(daily_return) - Average daily return percentage across selected period

---

#### DMO 3: dmo_portfolio_positions (Fact)

**Settings**:
- Name: `dmo_portfolio_positions`
- Label: "Portfolio Positions"
- Description: "Current portfolio holdings and allocations with portfolio attributes"
- Type: Fact

**Source**: `dlo_portfolio_positions`

**Fields**:
```
Field Name           Source Field         Type        Primary Key   Aggregation   Description
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
portfolio_id         portfolio_id        Text        ✓             -             Unique portfolio identifier (e.g., PF001, PF002) - Composite PK
portfolio_name       portfolio_name      Text                      -             Human-readable portfolio name (e.g., "Conservative Growth")
risk_tolerance       risk_tolerance      Text                      -             Portfolio risk profile: Low, Medium, or High
symbol               symbol              Text        ✓             -             Cryptocurrency ticker symbol held in this position - Composite PK
as_of_date           as_of_date          Date        ✓             -             Snapshot date when position was recorded (historical snapshots) - Composite PK
quantity             quantity            Number                    SUM           Number of cryptocurrency units held (e.g., 5.8230 BTC)
avg_cost             avg_cost            Number                    AVG           Average cost basis per unit in USD (for P&L calculation)
current_price        current_price       Number                    AVG           Current market price per unit in USD
position_value       position_value      Number                    SUM           Total position value in USD (quantity × current_price)
target_weight        target_weight       Number                    AVG           Target allocation percentage (0-1, e.g., 0.30 = 30%)
unrealized_pnl       unrealized_pnl      Number                    SUM           Unrealized profit/loss in USD: (current_price - avg_cost) × quantity
unrealized_pnl_pct   unrealized_pnl_pct  Number                    AVG           Unrealized return percentage: (current_price / avg_cost - 1) × 100
```

**Measures**:
- `total_position_value`: SUM(position_value) - Total portfolio value across all positions in USD
- `total_unrealized_pnl`: SUM(unrealized_pnl) - Total unrealized profit/loss across all positions
- `avg_pnl_pct`: AVG(unrealized_pnl_pct) - Average return percentage across positions
- `position_count`: COUNT_DISTINCT(symbol) - Number of unique assets held in portfolio

**Calculated Fields**:
```sql
-- risk_category: Human-readable risk classification for portfolio segmentation
-- Maps technical risk_tolerance field to business-friendly labels used in reports
risk_category = 
  CASE 
    WHEN risk_tolerance = 'Low' THEN 'Conservative'
    WHEN risk_tolerance = 'Medium' THEN 'Balanced'
    WHEN risk_tolerance = 'High' THEN 'Aggressive'
    ELSE 'Unknown'
  END

-- current_weight: Actual portfolio allocation percentage
-- Compares against target_weight to identify drift requiring rebalancing
current_weight = position_value / SUM(position_value) OVER (PARTITION BY portfolio_id)

-- weight_drift: Deviation from target allocation
-- Positive = overweight, Negative = underweight
weight_drift = current_weight - target_weight

-- needs_rebalance: Boolean flag for positions requiring rebalancing
-- Triggers when drift exceeds 10% threshold (configurable business preference)
needs_rebalance = ABS(weight_drift) > 0.10
```

---

#### DMO 4: dmo_trades (Fact)

**Settings**:
- Name: `dmo_trades`
- Label: "Trades"
- Description: "Trade transaction history"
- Type: Fact

**Source**: `dlo_trades`

**Fields**:
```
Field Name           Source Field         Type        Primary Key   Aggregation   Description
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
trade_id             trade_id            Text        ✓             -             Unique trade identifier (e.g., TRD000001) - Primary Key
trade_date           trade_date          DateTime                  -             Timestamp when trade was executed (YYYY-MM-DD HH:MM:SS)
portfolio_id         portfolio_id        Text                      -             Portfolio that executed the trade
symbol               symbol              Text                      -             Cryptocurrency traded (e.g., BTC, ETH)
trade_type           trade_type          Text                      -             Trade direction: BUY or SELL
quantity             quantity            Number                    SUM           Number of units traded (always positive)
price                price               Number                    AVG           Execution price per unit in USD
trade_amount         trade_amount        Number                    SUM           Total trade value in USD (quantity × price)
fee                  fee                 Number                    SUM           Trading fee paid to exchange in USD
exchange             exchange            Text                      -             Exchange where trade executed (Coinbase, Binance, Kraken)
order_type           order_type          Text                      -             Order type: Market (immediate) or Limit (price-specified)
```

**Measures**:
- `total_trade_amount`: SUM(trade_amount) - Total dollar volume of all trades executed
- `total_fees`: SUM(fee) - Total trading fees paid across all transactions
- `trade_count`: COUNT(trade_id) - Total number of trades executed
- `buy_count`: COUNT_IF(trade_type = 'BUY') - Number of buy orders executed
- `sell_count`: COUNT_IF(trade_type = 'SELL') - Number of sell orders executed
- `avg_trade_size`: AVG(trade_amount) - Average trade size in USD

---

#### DMO 5: dmo_market_metrics (Fact)

**Settings**:
- Name: `dmo_market_metrics`
- Label: "Market Metrics"
- Description: "Daily market-wide indicators"
- Type: Fact

**Source**: `dlo_market_metrics`

**Fields**:
```
Field Name           Source Field         Type        Primary Key   Aggregation   Description
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
date                 date                Date        ✓             -             Trading date for market-wide metrics - Primary Key
total_volume         total_volume        Number                    SUM           Aggregate trading volume across all 15 cryptocurrencies in USD
avg_return           avg_return          Number                    AVG           Average daily return percentage across all cryptos (market-wide)
market_volatility    market_volatility   Number                    AVG           Standard deviation of returns across all cryptos (market-wide risk)
btc_dominance_pct    btc_dominance_pct   Number                    AVG           Bitcoin's percentage of total market volume (market sentiment indicator)
positive_movers      positive_movers     Number                    SUM           Count of cryptocurrencies with positive returns for the day
negative_movers      negative_movers     Number                    SUM           Count of cryptocurrencies with negative returns for the day
total_assets         total_assets        Number                    AVG           Total number of cryptocurrencies tracked (always 15)
volatility_30d       volatility_30d      Number                    AVG           30-day rolling average of market volatility (smoothed)
volume_ma_7          volume_ma_7         Number                    AVG           7-day moving average of total market volume
```

**Measures**:
- `market_total_volume`: SUM(total_volume) - Total market trading volume across selected period
- `avg_market_return`: AVG(avg_return) - Average market return across selected period
- `avg_volatility`: AVG(market_volatility) - Average market-wide volatility (risk indicator)
- `avg_btc_dominance`: AVG(btc_dominance_pct) - Average Bitcoin market dominance percentage

---

#### DMO 6: dmo_correlation_matrix (Fact)

**Settings**:
- Name: `dmo_correlation_matrix`
- Label: "Correlation Matrix"
- Description: "Pairwise correlation coefficients between cryptocurrency returns (365-day rolling)"
- Type: Fact

**Source**: `dlo_correlation_matrix`

**Fields**:
```
Field Name              Source Field            Type        Primary Key   Aggregation   Description
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
crypto1                 crypto1                 Text        ✓             -             First cryptocurrency in correlation pair - Composite PK (1/2)
crypto2                 crypto2                 Text        ✓             -             Second cryptocurrency in correlation pair - Composite PK (2/2)
correlation             correlation             Number                    AVG           Pearson correlation coefficient (-1.0 to +1.0) between daily returns
is_self_correlation     is_self_correlation     Boolean                   -             True if crypto1 = crypto2 (diagonal, always 1.0)
period_days             period_days             Number                    AVG           Number of days used for correlation calculation (365)
period_start            period_start            Date                      MAX           Start date of correlation period
period_end              period_end              Date                      MAX           End date of correlation period
correlation_strength    correlation_strength    Text                      -             Category: Perfect/Very Strong/Strong/Moderate/Weak/Very Weak
correlation_direction   correlation_direction   Text                      -             Positive/Negative/Neutral
```

**Primary Key Constraint**: 
- Composite key: `crypto1` + `crypto2`
- Ensures one correlation value per pair
- Matrix is symmetric: corr(A, B) = corr(B, A)

**Measures**:
- `avg_correlation`: AVG(correlation) - Average correlation across selected pairs
- `max_correlation`: MAX(correlation) - Strongest positive correlation
- `min_correlation`: MIN(correlation) - Strongest negative correlation (or weakest positive)
- `pair_count`: COUNT(*) - Number of correlation pairs

**Calculated Fields**:
```sql
-- absolute_correlation: Magnitude of correlation regardless of direction
-- Used to find strongest relationships (positive or negative)
absolute_correlation = ABS(correlation)

-- is_strong_correlation: Flag for strong relationships (diversification check)
-- High values indicate assets move together (low diversification)
is_strong_correlation = ABS(correlation) >= 0.7

-- is_weak_correlation: Flag for independent movements (good diversification)
-- Low values indicate assets move independently (good for risk reduction)
is_weak_correlation = ABS(correlation) < 0.3

-- diversification_score: Inverse of correlation (100 = perfect diversification)
-- Higher score = better diversification benefit between assets
diversification_score = (1 - ABS(correlation)) * 100
```

**Data Quality Rules**:
- `correlation` must be between -1.0 and +1.0
- Self-correlations (`crypto1` = `crypto2`) must equal 1.0
- Matrix must be symmetric: correlation(A,B) = correlation(B,A)
- No missing values allowed

**Business Use Cases**:
1. **Correlation Heatmap**: Visualize all pairwise correlations in a grid
2. **Portfolio Diversification Analysis**: Identify low-correlation pairs for risk reduction
3. **Hedging Opportunities**: Find negative correlations for offsetting risk
4. **Concentration Risk**: Detect high correlations within portfolio holdings

**Interpretation Guide**:
- **+1.0**: Perfect positive correlation (move identically)
- **+0.8 to +0.99**: Very strong positive (move together)
- **+0.6 to +0.79**: Strong positive (similar movements)
- **+0.4 to +0.59**: Moderate positive (some relationship)
- **+0.2 to +0.39**: Weak positive (slight relationship)
- **-0.2 to +0.2**: No correlation (independent)
- **-0.2 to -0.39**: Weak negative (slight opposite)
- **-0.4 to -0.59**: Moderate negative (opposite movements)
- **-0.6 to -0.79**: Strong negative (move opposite)
- **-0.8 to -0.99**: Very strong negative (mirror opposite)
- **-1.0**: Perfect negative correlation (exact opposites)

---

### Pre-Calculated KPI DMOs

The following 5 DMOs contain pre-calculated KPIs that eliminate complex LOD expressions in the semantic layer.

#### DMO 7: dmo_kpi_volatility (Fact)

**Settings**:
- Name: `dmo_kpi_volatility`
- Label: "Portfolio Volatility Time Series"
- Description: "Pre-calculated rolling volatility for each portfolio by date"
- Type: Fact
- Source: `kpi_portfolio_volatility_timeseries.csv`

**Fields**:
```
Field Name                  Type        Primary Key   Aggregation   Description
──────────────────────────────────────────────────────────────────────────────────────────────────
portfolio_id                Text        ✓             -             Portfolio identifier (PF001, PF002, PF003) - Composite PK
portfolio_name              Text                      -             Portfolio display name
date                        Date        ✓             -             Calculation date - Composite PK
volatility_30d              Number                    AVG           30-day annualized volatility (NULL for first 29 days)
volatility_90d              Number                    AVG           90-day annualized volatility (NULL for first 89 days)
volatility_365d             Number                    AVG           365-day annualized volatility (NULL for first 364 days)
downside_volatility_365d    Number                    AVG           365-day downside volatility (for Sortino Ratio)
```

**Usage**: Simply reference these fields in semantic layer with AVG aggregation. No date filters or LOD expressions needed!

---

#### DMO 8: dmo_kpi_var (Fact)

**Settings**:
- Name: `dmo_kpi_var`
- Label: "Portfolio Value at Risk"
- Description: "Pre-calculated VaR using current portfolio positions"
- Type: Fact
- Source: `kpi_portfolio_var_current.csv`

**Fields**:
```
Field Name          Type        Primary Key   Aggregation   Description
─────────────────────────────────────────────────────────────────────────────────────────────────
portfolio_id        Text        ✓             -             Portfolio identifier - Composite PK
portfolio_name      Text                      -             Portfolio display name
as_of_date          Date        ✓             -             Calculation date (2026-01-09) - Composite PK
portfolio_value     Number                    SUM           Total portfolio value
var_95              Number                    SUM           Value at Risk at 95% confidence (negative dollar amount)
var_99              Number                    SUM           Value at Risk at 99% confidence (negative dollar amount)
var_95_pct          Number                    AVG           VaR 95% as percentage of portfolio value
var_99_pct          Number                    AVG           VaR 99% as percentage of portfolio value
```

**Expected Values**:
- Conservative Growth: VaR 95% = -$5,055 (5.2%)
- Balanced Portfolio: VaR 95% = -$11,829 (4.7%)
- High Growth: VaR 95% = -$23,403 (5.9%)

---

#### DMO 9: dmo_kpi_risk_adjusted (Fact)

**Settings**:
- Name: `dmo_kpi_risk_adjusted`
- Label: "Portfolio Risk-Adjusted Returns"
- Description: "Pre-calculated Sharpe, Sortino, Beta, Alpha, Correlation"
- Type: Fact
- Source: `kpi_portfolio_risk_adjusted_returns.csv`

**Fields**:
```
Field Name                      Type        Primary Key   Aggregation   Description
───────────────────────────────────────────────────────────────────────────────────────────────────────
portfolio_id                    Text        ✓             -             Portfolio identifier - Composite PK
portfolio_name                  Text                      -             Portfolio display name
as_of_date                      Date        ✓             -             Calculation date - Composite PK
portfolio_value                 Number                    SUM           Total portfolio value
cost_basis                      Number                    SUM           Total cost basis (original investment)
portfolio_return_annualized     Number                    AVG           Annualized portfolio return (decimal)
sharpe_ratio                    Number                    AVG           Risk-adjusted return (Sharpe)
sortino_ratio                   Number                    AVG           Downside risk-adjusted return (Sortino)
beta_vs_btc                     Number                    AVG           Portfolio sensitivity to Bitcoin
alpha                           Number                    AVG           Excess return vs Bitcoin (annualized)
correlation_to_btc              Number                    AVG           Correlation coefficient with Bitcoin
```

**Expected Values**:
- Conservative Growth: Sharpe = 0.19, Beta = 0.86
- Balanced Portfolio: Sharpe = 0.02, Beta = 0.74
- High Growth: Sharpe = 0.04, Beta = 0.76

---

#### DMO 10: dmo_kpi_concentration (Fact)

**Settings**:
- Name: `dmo_kpi_concentration`
- Label: "Portfolio Concentration Metrics"
- Description: "Pre-calculated position weights, HHI, and concentration metrics"
- Type: Fact
- Source: `kpi_portfolio_concentration.csv`

**Fields**:
```
Field Name                      Type        Primary Key   Aggregation   Description
───────────────────────────────────────────────────────────────────────────────────────────────────────
portfolio_id                    Text        ✓             -             Portfolio identifier - Composite PK (1/3)
portfolio_name                  Text                      -             Portfolio display name
as_of_date                      Date        ✓             -             Calculation date - Composite PK (2/3)
symbol                          Text        ✓             -             Cryptocurrency symbol - Composite PK (3/3)
position_value                  Number                    SUM           Position value in USD
position_weight                 Number                    AVG           Actual weight (0-1, multiply by 100 for %)
target_weight                   Number                    AVG           Target allocation weight
weight_drift                    Number                    AVG           Difference from target (positive = overweight)
is_overweight                   Boolean                   -             TRUE if > 10% above target
is_underweight                  Boolean                   -             TRUE if > 10% below target
portfolio_hhi                   Number                    AVG           Herfindahl Index (concentration measure, 0-1)
portfolio_liquid_assets_pct     Number                    AVG           % of portfolio in liquid assets
```

**Expected Values**:
- Conservative Growth: HHI = 0.359 (Concentrated)
- Balanced Portfolio: HHI = 0.231 (Moderate)
- High Growth: HHI = 0.227 (Diversified)

---

#### DMO 11: dmo_kpi_24h_change (Fact)

**Settings**:
- Name: `dmo_kpi_24h_change`
- Label: "Portfolio 24h Change"
- Description: "Pre-calculated daily portfolio value changes"
- Type: Fact
- Source: `kpi_portfolio_24h_change.csv`

**Fields**:
```
Field Name          Type        Primary Key   Aggregation   Description
─────────────────────────────────────────────────────────────────────────────────────────────────
portfolio_id        Text        ✓             -             Portfolio identifier - Composite PK
portfolio_name      Text                      -             Portfolio display name
date                Date        ✓             -             Date of calculation - Composite PK
portfolio_value     Number                    SUM           Portfolio value on this date
change_24h          Number                    SUM           Dollar change from previous day
change_24h_pct      Number                    AVG           Percentage change from previous day
```

**Usage**: Filter to `date = MAX(date)` to show latest 24h change in dashboard KPI cards.

---

## Phase 5: Relationships

**Navigation**: Data Cloud → Data Model → Relationships → New Relationship

### ⚠️ CRITICAL: Date Joins Required for KPI DMOs

**All KPI relationships (4-8) MUST include date joins** to prevent cross-joining that multiplies values by 365+:
- Without date joins: VaR values will be **365x too large** (-$5K becomes -$1.8M)
- Without date joins: Portfolio values will be summed across all dates (correct: $100K, wrong: $36M)
- Without date joins: Sharpe/Beta values will be averaged incorrectly

**Date field mappings**:
- `dmo_kpi_volatility.date` → `dmo_portfolio_positions.as_of_date`
- `dmo_kpi_var.as_of_date` → `dmo_portfolio_positions.as_of_date`
- `dmo_kpi_risk_adjusted.as_of_date` → `dmo_portfolio_positions.as_of_date`
- `dmo_kpi_concentration.as_of_date` → `dmo_portfolio_positions.as_of_date`
- `dmo_kpi_24h_change.date` → `dmo_portfolio_positions.as_of_date`

---

Create the following relationships:

### Relationship 1: Prices → Cryptocurrency

```
Source DMO:     dmo_crypto_prices
Target DMO:     dmo_cryptocurrency
Type:           Many-to-One
Join Condition: dmo_crypto_prices.symbol = dmo_cryptocurrency.symbol
Cardinality:    Many prices per crypto
```

### Relationship 2: Positions → Cryptocurrency

```
Source DMO:     dmo_portfolio_positions
Target DMO:     dmo_cryptocurrency
Type:           Many-to-One
Join Condition: dmo_portfolio_positions.symbol = dmo_cryptocurrency.symbol
Cardinality:    Many positions per crypto
```

### Relationship 3: Trades → Cryptocurrency

```
Source DMO:     dmo_trades
Target DMO:     dmo_cryptocurrency
Type:           Many-to-One
Join Condition: dmo_trades.symbol = dmo_cryptocurrency.symbol
Cardinality:    Many trades per crypto
```

### KPI Relationships (New)

#### Relationship 4: KPI Volatility → Portfolio Positions

```
Source DMO:     dmo_kpi_volatility
Target DMO:     dmo_portfolio_positions
Type:           Many-to-One
Join Conditions: 
  1. dmo_kpi_volatility.portfolio_id = dmo_portfolio_positions.portfolio_id
  2. dmo_kpi_volatility.date = dmo_portfolio_positions.as_of_date
Cardinality:    Many volatility records per portfolio (one per date)
```

**CRITICAL**: The date join is essential to prevent cross-joining all volatility dates with all position dates, which would multiply values by 365+.

#### Relationship 5: KPI VaR → Portfolio Positions

```
Source DMO:     dmo_kpi_var
Target DMO:     dmo_portfolio_positions
Type:           One-to-One (per date)
Join Conditions:
  1. dmo_kpi_var.portfolio_id = dmo_portfolio_positions.portfolio_id
  2. dmo_kpi_var.as_of_date = dmo_portfolio_positions.as_of_date
Cardinality:    One VaR record per portfolio per date
```

**CRITICAL**: Without the date join, the single VaR record for 2026-01-09 will match ALL 365+ position dates, multiplying VaR values by 365+.

#### Relationship 6: KPI Risk-Adjusted → Portfolio Positions

```
Source DMO:     dmo_kpi_risk_adjusted
Target DMO:     dmo_portfolio_positions
Type:           One-to-One (per date)
Join Conditions:
  1. dmo_kpi_risk_adjusted.portfolio_id = dmo_portfolio_positions.portfolio_id
  2. dmo_kpi_risk_adjusted.as_of_date = dmo_portfolio_positions.as_of_date
Cardinality:    One risk-adjusted record per portfolio per date
```

**CRITICAL**: Without the date join, Sharpe/Sortino/Beta values will be averaged across multiple dates, producing incorrect results.

#### Relationship 7a: KPI Concentration → Cryptocurrency

```
Source DMO:     dmo_kpi_concentration
Target DMO:     dmo_cryptocurrency
Type:           Many-to-One
Join Condition: dmo_kpi_concentration.symbol = dmo_cryptocurrency.symbol
Cardinality:    Many concentration records per crypto
```

#### Relationship 7b: KPI Concentration → Portfolio Positions

```
Source DMO:     dmo_kpi_concentration
Target DMO:     dmo_portfolio_positions
Type:           Many-to-One
Join Conditions:
  1. dmo_kpi_concentration.portfolio_id = dmo_portfolio_positions.portfolio_id
  2. dmo_kpi_concentration.symbol = dmo_portfolio_positions.symbol
  3. dmo_kpi_concentration.as_of_date = dmo_portfolio_positions.as_of_date
Cardinality:    One concentration record per position per date
```

**CRITICAL**: The triple join (portfolio_id + symbol + as_of_date) ensures each position's concentration metrics match exactly with the corresponding portfolio position record.

#### Relationship 8: KPI 24h Change → Portfolio Positions

```
Source DMO:     dmo_kpi_24h_change
Target DMO:     dmo_portfolio_positions
Type:           Many-to-One
Join Conditions:
  1. dmo_kpi_24h_change.portfolio_id = dmo_portfolio_positions.portfolio_id
  2. dmo_kpi_24h_change.date = dmo_portfolio_positions.as_of_date
Cardinality:    Many daily change records per portfolio (one per date)
```

**CRITICAL**: Without the date join, 24h change values will be summed across all dates, producing values that are 365+ times too large.

---

### Relationship Summary

Total Relationships: **9** (3 static + 6 date-based)

| # | Source DMO | Target DMO | Join Fields | Date Join? |
|---|-----------|-----------|-------------|-----------|
| 1 | dmo_crypto_prices | dmo_cryptocurrency | symbol | No (static) |
| 2 | dmo_portfolio_positions | dmo_cryptocurrency | symbol | No (static) |
| 3 | dmo_trades | dmo_cryptocurrency | symbol | No (static) |
| 4 | dmo_kpi_volatility | dmo_portfolio_positions | portfolio_id + **date** | ✅ Yes |
| 5 | dmo_kpi_var | dmo_portfolio_positions | portfolio_id + **as_of_date** | ✅ Yes |
| 6 | dmo_kpi_risk_adjusted | dmo_portfolio_positions | portfolio_id + **as_of_date** | ✅ Yes |
| 7a | dmo_kpi_concentration | dmo_cryptocurrency | symbol | No (static) |
| 7b | dmo_kpi_concentration | dmo_portfolio_positions | portfolio_id + symbol + **as_of_date** | ✅ Yes |
| 8 | dmo_kpi_24h_change | dmo_portfolio_positions | portfolio_id + **date** | ✅ Yes |

**Validation**: After creating relationships, verify:
1. ✅ Portfolio values: $97K-$398K (not millions)
2. ✅ VaR 95%: -$5K to -$23K (not millions)
3. ✅ Sharpe Ratio: 0.02 to 0.19 (positive values)
4. ✅ Values change day-to-day (not constant)

---

## Phase 6: Calculated Fields

Add these calculated fields to DMOs for advanced analytics:

### In dmo_crypto_prices:

```sql
-- price_change: Absolute dollar change from open to close
-- Used to calculate intraday movement magnitude
price_change = close - open

-- price_change_pct: Percentage change from open to close
-- Intraday return percentage, normalized for comparison across different price levels
price_change_pct = ((close - open) / open) * 100

-- true_range: True Range indicator for volatility measurement
-- Captures full trading range including overnight gaps
-- Used in Average True Range (ATR) calculations for risk assessment
true_range = MAX(high - low, ABS(high - LAG(close)), ABS(low - LAG(close)))

-- market_sentiment: Simplified bull/bear classification
-- Bullish = buyers dominated (close > open), Bearish = sellers dominated (close < open)
-- Used for quick sentiment analysis and filtering
market_sentiment = 
  CASE 
    WHEN close > open THEN 'Bullish'
    WHEN close < open THEN 'Bearish'
    ELSE 'Neutral'
  END

-- volatility_percentile: Ranks current volatility against historical distribution
-- Values 0-100 where 100 = highest volatility observed
-- Helps identify unusually volatile periods
volatility_percentile = PERCENT_RANK() OVER (PARTITION BY symbol ORDER BY volatility_30d) * 100
```

### In dmo_portfolio_positions:

```sql
-- Current allocation weight
current_weight = position_value / SUM(position_value) OVER (PARTITION BY portfolio_id)

-- Weight drift from target
weight_drift = current_weight - target_weight

-- Requires rebalancing (drift > 10%)
needs_rebalance = ABS(weight_drift) > 0.10

-- Position size category
position_size_category = 
  CASE 
    WHEN position_value > 100000 THEN 'Large'
    WHEN position_value > 50000 THEN 'Medium'
    ELSE 'Small'
  END
```

### In dmo_trades:

```sql
-- trade_direction: Numeric encoding of buy/sell for calculations
-- +1 = BUY (cash out, crypto in), -1 = SELL (crypto out, cash in), 0 = other
-- Used for net flow calculations and portfolio impact analysis
trade_direction = 
  CASE 
    WHEN trade_type = 'BUY' THEN 1
    WHEN trade_type = 'SELL' THEN -1
    ELSE 0
  END

-- net_trade_amount: Signed trade amount for cash flow analysis
-- Positive = money leaving account (buying), Negative = money entering (selling)
-- Useful for tracking net capital deployed vs. withdrawn
net_trade_amount = trade_amount * trade_direction

-- fee_pct: Trading fee as percentage of trade amount
-- Typical range: 0.1% - 0.5% depending on exchange and volume
-- Used to compare exchange costs and optimize trade routing
fee_pct = (fee / trade_amount) * 100

-- is_large_trade: Flags significant trades for review
-- Threshold: > $10,000 (configurable via business preferences)
-- Used for compliance monitoring and risk alerts
is_large_trade = trade_amount > 10000

-- days_since_trade: Recency indicator
-- Helps identify stale positions and recent activity
days_since_trade = DATEDIFF(day, trade_date, CURRENT_DATE())
```

---

## Phase 7: Validation

### Data Quality Checks

Run these queries to validate your setup:

```sql
-- 1. Check record counts
SELECT COUNT(*) FROM dmo_crypto_prices;      -- Should be ~27,405
SELECT COUNT(*) FROM dmo_portfolio_positions; -- Should be 17
SELECT COUNT(*) FROM dmo_trades;              -- Should be 88
SELECT COUNT(*) FROM dmo_market_metrics;      -- Should be 1,827

-- 2. Verify relationships
SELECT 
  cp.symbol,
  c.name,
  COUNT(*) as price_records
FROM dmo_crypto_prices cp
JOIN dmo_cryptocurrency c ON cp.symbol = c.symbol
GROUP BY cp.symbol, c.name;

-- 3. Check portfolio totals
SELECT 
  portfolio_name,
  SUM(position_value) as total_value,
  COUNT(*) as num_positions
FROM dmo_portfolio_positions
GROUP BY portfolio_name;

-- 4. Validate date range and attributes
SELECT 
  MIN(date) as min_date,
  MAX(date) as max_date,
  COUNT(DISTINCT date) as trading_days,
  COUNT(DISTINCT year) as years,
  COUNT(DISTINCT month) as months
FROM dmo_crypto_prices;
```

### Expected Results

- ✓ All DMOs have correct record counts
- ✓ All relationships return joined data
- ✓ No NULL values in key fields
- ✓ Date range: 2020-01-01 to 2024-12-31
- ✓ Portfolio totals: Conservative $100k, Balanced $250k, Aggressive $500k
- ✓ Date attributes (year, month, quarter) populated correctly

---

## Next Steps

1. ✅ Data Cloud setup complete
2. → Proceed to [Semantic Layer Configuration](../config/semantic_layer_config.yaml)
3. → Create [Dashboard Wireframes](dashboard_wireframes.md)
4. → Configure [Agentforce Actions](agentforce_setup.md)

---

## Troubleshooting

**Issue**: CSV upload fails with "Field not mapped"
**Solution**: Ensure CSV column names exactly match the field mappings above

**Issue**: Relationship join returns no data
**Solution**: Verify join keys match (case-sensitive), check for NULL values

**Issue**: Calculated field shows NULL
**Solution**: Check that source fields exist and have data, verify SQL syntax

**Issue**: DMO refresh fails
**Solution**: Check DLO has completed refresh first, verify no circular dependencies

---

## Additional Resources

- [Salesforce Data Cloud Documentation](https://help.salesforce.com/s/articleView?id=sf.c360_a_data_cloud.htm)
- [Tableau Semantic Layer Guide](https://help.tableau.com/current/online/en-us/dm_semantic_layer.htm)
- [Data Model Best Practices](https://help.salesforce.com/s/articleView?id=sf.c360_a_data_model.htm)
