# CryptoRisk Analytics - Agentforce Setup Guide

> **ğŸ“‹ STATUS: ROADMAP FEATURE**  
> This document outlines the planned Agentforce integration for CryptoRisk Analytics. The semantic layer is **already configured** with consolidated business preferences and is **ready for Agentforce integration**. The custom objects, flows, and action buttons described here are included for future implementation (Phase 2 of roadmap).
>
> **Current Status**:
> - âœ… Semantic layer configured with AI-ready business preferences
> - âœ… Agentforce Concierge can query the semantic layer (natural language ready)
> - âœ… Custom object definitions and flow configs included in `/config`
> - ğŸ”œ Action buttons and automated workflows (next phase)

---

Complete configuration for Salesforce Agentforce including custom objects, flows, and Concierge AI setup.

---

## Table of Contents

- [Overview](#overview)
- [Phase 1: Custom Objects](#phase-1-custom-objects)
- [Phase 2: Salesforce Flows](#phase-2-salesforce-flows)
- [Phase 3: Concierge Configuration](#phase-3-concierge-configuration)
- [Phase 4: Testing](#phase-4-testing)
- [Phase 5: Permissions](#phase-5-permissions)

---

## Overview

**Agentforce Components (Planned)**:
- 3 Custom Objects (for storing action results)
- 3 Salesforce Flows (automation logic)
- 1 Concierge AI Agent (conversational interface - **ready to configure**)
- 5 test prompts (validation)

**User Journey (Future)**:
1. User asks Concierge: "What's my portfolio risk?"
2. Concierge queries semantic layer, explains risk drivers (**works today**)
3. User says: "Recommend a rebalance"
4. Concierge triggers flow, creates rebalancing task (**roadmap**)
5. User reviews and approves suggested trades (**roadmap**)

---

## Phase 1: Custom Objects

### Object 1: Risk_Alert__c

**Purpose**: Track portfolio risk alerts generated by the system

**Navigation**: Setup â†’ Object Manager â†’ Create â†’ Custom Object

**Object Settings**:
```
Label: Risk Alert
Plural Label: Risk Alerts
Object Name: Risk_Alert__c
Record Name: Alert Number
Data Type: Auto Number
Display Format: ALERT-{00000}
Starting Number: 00001
```

**Fields**:

| API Name | Label | Type | Description |
|----------|-------|------|-------------|
| `Portfolio__c` | Portfolio | Lookup(Portfolio) | Related portfolio |
| `Alert_Type__c` | Alert Type | Picklist | Type of risk alert |
| `Severity__c` | Severity | Picklist | Critical/Warning/Info |
| `Asset_Symbol__c` | Asset Symbol | Text(10) | Affected crypto (if asset-specific) |
| `Metric_Name__c` | Metric Name | Text(50) | Which risk metric triggered alert |
| `Current_Value__c` | Current Value | Number(18,4) | Current metric value |
| `Threshold_Value__c` | Threshold Value | Number(18,4) | Alert threshold that was exceeded |
| `Triggered_Date__c` | Triggered Date | DateTime | When alert was created |
| `Status__c` | Status | Picklist | Active/Acknowledged/Resolved |
| `Priority__c` | Priority | Number | 1 (high) to 5 (low) |
| `Description__c` | Description | Long Text Area | Detailed alert explanation |
| `Recommended_Action__c` | Recommended Action | Long Text Area | Suggested remediation |
| `Acknowledged_By__c` | Acknowledged By | Lookup(User) | User who acknowledged |
| `Acknowledged_Date__c` | Acknowledged Date | DateTime | When acknowledged |
| `Resolved_Date__c` | Resolved Date | DateTime | When resolved |

**Picklist Values**:

`Alert_Type__c`:
- High Volatility
- Concentration Risk
- VaR Threshold Exceeded
- Max Drawdown
- Liquidity Concern
- Correlation Risk

`Severity__c`:
- Critical ğŸ”´
- Warning ğŸŸ¡
- Info ğŸŸ¢

`Status__c`:
- Active (default)
- Acknowledged
- Resolved
- False Positive

**Page Layouts**:
- Create layout with logical groupings:
  - Alert Details (type, severity, status)
  - Metrics (current value, threshold, metric name)
  - Portfolio Context (portfolio, asset)
  - Resolution (acknowledged by/date, resolved date)

**Validation Rules**:
```
Rule Name: Threshold_Must_Be_Exceeded
Formula: Current_Value__c < Threshold_Value__c
Error: Current value must exceed threshold to create alert
```

---

### Object 2: Rebalance_Task__c

**Purpose**: Store portfolio rebalancing recommendations and execution tracking

**Object Settings**:
```
Label: Rebalance Task
Plural Label: Rebalance Tasks
Object Name: Rebalance_Task__c
Record Name: Task Number
Data Type: Auto Number
Display Format: REBAL-{00000}
Starting Number: 00001
```

**Fields**:

| API Name | Label | Type | Description |
|----------|-------|------|-------------|
| `Portfolio__c` | Portfolio | Lookup(Portfolio) | Portfolio to rebalance |
| `Created_Date__c` | Created Date | DateTime | When task was generated |
| `Status__c` | Status | Picklist | Pending/Approved/Executed/Cancelled |
| `Rebalance_Reason__c` | Reason | Long Text Area | Why rebalancing is needed |
| `Target_Allocation__c` | Target Allocation | Long Text Area(JSON) | Desired weights |
| `Current_Allocation__c` | Current Allocation | Long Text Area(JSON) | Current weights |
| `Drift_Analysis__c` | Drift Analysis | Long Text Area | Weight differences |
| `Suggested_Trades__c` | Suggested Trades | Long Text Area | List of buy/sell orders |
| `Estimated_Cost__c` | Estimated Cost | Currency | Trading fees estimate |
| `Expected_Benefit__c` | Expected Benefit | Long Text Area | Improvement explanation |
| `Approved_By__c` | Approved By | Lookup(User) | Approving manager |
| `Approved_Date__c` | Approved Date | DateTime | Approval timestamp |
| `Executed_Date__c` | Executed Date | DateTime | When trades executed |
| `Execution_Notes__c` | Execution Notes | Long Text Area | Post-trade notes |
| `Priority__c` | Priority | Picklist | High/Medium/Low |

**Picklist Values**:

`Status__c`:
- Pending (default)
- Under Review
- Approved
- Executing
- Executed
- Cancelled
- Failed

`Priority__c`:
- High (drift > 15%)
- Medium (drift 10-15%)
- Low (drift < 10%)

---

### Object 3: Portfolio__c (Dimension Master)

**Purpose**: Master data for portfolios (if not using Account)

**Object Settings**:
```
Label: Portfolio
Plural Label: Portfolios
Object Name: Portfolio__c
Record Name: Portfolio Name
Data Type: Text
```

**Fields**:

| API Name | Label | Type | Description |
|----------|-------|------|-------------|
| `Portfolio_ID__c` | Portfolio ID | Text(10) | External ID (PF001, PF002, etc.) |
| `Portfolio_Name__c` | Portfolio Name | Text(80) | Display name |
| `Risk_Tolerance__c` | Risk Tolerance | Picklist | Low/Medium/High |
| `Total_Value__c` | Total Value | Currency | Current portfolio value |
| `Owner__c` | Portfolio Manager | Lookup(User) | Responsible manager |
| `Benchmark__c` | Benchmark | Text(10) | Comparison asset (BTC) |
| `Target_Return__c` | Target Return | Percent | Annual target |
| `Max_Volatility__c` | Max Volatility | Percent | Risk constraint |
| `Status__c` | Status | Picklist | Active/Inactive/Under Review |
| `Created_Date__c` | Created Date | Date | Portfolio inception |
| `Last_Rebalanced__c` | Last Rebalanced | Date | Most recent rebalance |

---

## Phase 2: Salesforce Flows

### Flow 1: Create_Risk_Alert

**Type**: Record-Triggered Flow (After Save)
**Trigger**: When risk metric exceeds threshold (from scheduled job or external system)

**Flow Logic**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TRIGGER: API call from Tableau dashboard           â”‚
â”‚ (User clicks "Create Alert" button)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET: Query current risk metrics from Data Cloud     â”‚
â”‚ Input: Portfolio ID, Metric Name                    â”‚
â”‚ Output: Current value, historical values            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DECISION: Does metric exceed threshold?             â”‚
â”‚ Formula: Current_Value > Threshold_Value            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ YES              â”‚ NO
              v                  v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CREATE: Risk_Alert__c  â”‚   â”‚ LOG: No action      â”‚
â”‚ Fields:                â”‚   â”‚ Send "All Good" msg â”‚
â”‚ - Portfolio            â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ - Alert_Type           â”‚
â”‚ - Severity             â”‚
â”‚ - Current_Value        â”‚
â”‚ - Threshold_Value      â”‚
â”‚ - Status = "Active"    â”‚
â”‚ - Priority (calc)      â”‚
â”‚ - Description          â”‚
â”‚ - Recommended_Action   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SEND EMAIL: Notify portfolio manager                â”‚
â”‚ Template: "Risk Alert Created"                      â”‚
â”‚ To: Portfolio owner                                  â”‚
â”‚ Body: Alert details + dashboard link                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST TO SLACK: Risk channel notification            â”‚
â”‚ (Optional - requires Slack integration)             â”‚
â”‚ Message: "ğŸ”´ ALERT: {Portfolio} - {Metric}"        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Flow Elements**:

1. **Start**: Platform Event or API-triggered
2. **Get Records**: Query Data Cloud for portfolio metrics
3. **Decision**: Compare to threshold
4. **Create Records**: New Risk_Alert__c
5. **Send Email**: Email alert template
6. **Post to Slack**: Slack API callout (optional)

**Variables**:
- `varPortfolioId` (Text)
- `varMetricName` (Text)
- `varCurrentValue` (Number)
- `varThreshold` (Number)
- `varSeverity` (Text)

---

### Flow 2: Recommend_Rebalance

**Type**: Screen Flow (user-initiated)
**Trigger**: Button click from dashboard or Concierge command

**Flow Logic**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCREEN 1: Select Portfolio                          â”‚
â”‚ Input: Dropdown of active portfolios                â”‚
â”‚ Button: "Analyze"                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET: Current positions from Data Cloud              â”‚
â”‚ Query: dmo_portfolio_positions WHERE portfolio_id   â”‚
â”‚ Output: List of current holdings + weights          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET: Target allocation from Portfolio__c            â”‚
â”‚ Query: Target_Allocation__c field                   â”‚
â”‚ Output: JSON of target weights                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ APEX: Calculate drift + suggested trades            â”‚
â”‚ Class: RebalanceCalculator.calculateTrades()        â”‚
â”‚ Logic:                                               â”‚
â”‚ - Compare current vs target weights                 â”‚
â”‚ - Identify positions to reduce (sell)               â”‚
â”‚ - Identify positions to increase (buy)              â”‚
â”‚ - Optimize for minimal trades + fees                â”‚
â”‚ Output: List<Trade> suggestedTrades                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DECISION: Is rebalancing needed?                    â”‚
â”‚ Formula: MAX(abs(current - target)) > 10%           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ YES              â”‚ NO
              v                  v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCREEN 2: Show trades  â”‚   â”‚ SCREEN: No action   â”‚
â”‚ Display:               â”‚   â”‚ "Portfolio aligned" â”‚
â”‚ - Current vs Target    â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ - Suggested trades     â”‚
â”‚ - Estimated fees       â”‚
â”‚ - Expected benefit     â”‚
â”‚ Buttons:               â”‚
â”‚ [Approve] [Modify]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CREATE: Rebalance_Task__c                           â”‚
â”‚ Fields:                                              â”‚
â”‚ - Portfolio                                          â”‚
â”‚ - Status = "Pending"                                 â”‚
â”‚ - Suggested_Trades (JSON)                           â”‚
â”‚ - Current_Allocation                                 â”‚
â”‚ - Target_Allocation                                  â”‚
â”‚ - Estimated_Cost                                     â”‚
â”‚ - Priority (based on drift %)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SCREEN 3: Confirmation                               â”‚
â”‚ "Rebalance task created! Task #REBAL-00123"        â”‚
â”‚ Button: "View Task" â†’ Navigate to record            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Apex Class** (to support flow):

```apex
public class RebalanceCalculator {
    
    @InvocableMethod(label='Calculate Rebalance Trades')
    public static List<RebalanceResult> calculateTrades(List<RebalanceRequest> requests) {
        List<RebalanceResult> results = new List<RebalanceResult>();
        
        for (RebalanceRequest req : requests) {
            RebalanceResult result = new RebalanceResult();
            
            // Parse current and target allocations
            Map<String, Decimal> current = parseAllocation(req.currentAllocation);
            Map<String, Decimal> target = parseAllocation(req.targetAllocation);
            
            // Calculate drifts
            List<Trade> trades = new List<Trade>();
            Decimal totalValue = req.portfolioValue;
            
            for (String symbol : target.keySet()) {
                Decimal currentWeight = current.get(symbol) != null ? current.get(symbol) : 0;
                Decimal targetWeight = target.get(symbol);
                Decimal drift = targetWeight - currentWeight;
                
                if (Math.abs(drift) > 0.01) {  // Only if > 1% drift
                    Trade t = new Trade();
                    t.symbol = symbol;
                    t.tradeType = drift > 0 ? 'BUY' : 'SELL';
                    t.amountUSD = Math.abs(drift * totalValue);
                    t.currentWeight = currentWeight;
                    t.targetWeight = targetWeight;
                    trades.add(t);
                }
            }
            
            result.suggestedTrades = trades;
            result.needsRebalance = !trades.isEmpty();
            result.maxDrift = calculateMaxDrift(current, target);
            
            results.add(result);
        }
        
        return results;
    }
    
    // Helper classes
    public class RebalanceRequest {
        @InvocableVariable public String currentAllocation;
        @InvocableVariable public String targetAllocation;
        @InvocableVariable public Decimal portfolioValue;
    }
    
    public class RebalanceResult {
        @InvocableVariable public List<Trade> suggestedTrades;
        @InvocableVariable public Boolean needsRebalance;
        @InvocableVariable public Decimal maxDrift;
    }
    
    public class Trade {
        @InvocableVariable public String symbol;
        @InvocableVariable public String tradeType;
        @InvocableVariable public Decimal amountUSD;
        @InvocableVariable public Decimal currentWeight;
        @InvocableVariable public Decimal targetWeight;
    }
}
```

---

### Flow 3: Send_Risk_Report

**Type**: Scheduled Flow (runs daily) or Platform Event-triggered
**Trigger**: Daily at 8 AM or on-demand from dashboard

**Flow Logic**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TRIGGER: Schedule (daily) or Button click           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET: All active portfolios                           â”‚
â”‚ Query: Portfolio__c WHERE Status = 'Active'         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LOOP: For each portfolio                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET: Risk metrics from Data Cloud                    â”‚
â”‚ Query: risk_metrics_portfolio WHERE portfolio_id    â”‚
â”‚ Fields: volatility, VaR, Sharpe, etc.               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GET: Active alerts for portfolio                     â”‚
â”‚ Query: Risk_Alert__c WHERE Status = 'Active'        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ APEX: Generate HTML report                           â”‚
â”‚ Class: RiskReportGenerator.generateReport()         â”‚
â”‚ Output: HTML string with:                            â”‚
â”‚ - Executive summary                                  â”‚
â”‚ - Key risk metrics table                            â”‚
â”‚ - Alert list (if any)                               â”‚
â”‚ - Charts (embedded images from dashboard)           â”‚
â”‚ - Recommended actions                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ SEND EMAIL: Portfolio risk report                    â”‚
â”‚ Template: "Daily Risk Report"                        â”‚
â”‚ To: Portfolio owner + risk team                      â”‚
â”‚ Attachments: PDF version (if needed)                â”‚
â”‚ Body: HTML report                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ (OPTIONAL) POST TO SLACK: Daily summary              â”‚
â”‚ Channel: #crypto-risk-updates                        â”‚
â”‚ Message: "ğŸ“Š Daily Risk Report: {date}"             â”‚
â”‚ Link: Dashboard URL                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Email Template** (`Daily_Risk_Report`):

```html
<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: Arial, sans-serif; }
        .metric { display: inline-block; margin: 10px; padding: 15px; 
                  background: #f5f5f5; border-radius: 8px; }
        .alert { padding: 10px; margin: 5px 0; border-left: 4px solid red; 
                 background: #fff3f3; }
    </style>
</head>
<body>
    <h1>Portfolio Risk Report - {!Portfolio__c.Portfolio_Name__c}</h1>
    <p>Date: {!TODAY()}</p>
    
    <h2>Key Metrics</h2>
    <div class="metric">
        <strong>Total Value:</strong> ${!Portfolio__c.Total_Value__c}
    </div>
    <div class="metric">
        <strong>Volatility (30d):</strong> {!Volatility_30d}%
    </div>
    <div class="metric">
        <strong>VaR 95%:</strong> -${!VaR_95}
    </div>
    <div class="metric">
        <strong>Sharpe Ratio:</strong> {!Sharpe_Ratio}
    </div>
    
    <h2>Active Alerts ({!Alert_Count})</h2>
    {IF Alert_Count > 0}
        <div class="alert">
            ğŸ”´ {!Alert_Details}
        </div>
    {ELSE}
        <p>âœ… No active alerts. Portfolio within acceptable risk parameters.</p>
    {ENDIF}
    
    <h2>Recommended Actions</h2>
    <ul>
        <li>{!Recommended_Action_1}</li>
        <li>{!Recommended_Action_2}</li>
    </ul>
    
    <p><a href="{!Dashboard_URL}">View Full Dashboard â†’</a></p>
    
    <hr>
    <small>This is an automated report from CryptoRisk Analytics.</small>
</body>
</html>
```

---

## Phase 3: Concierge Configuration

**Navigation**: Setup â†’ Einstein â†’ Agentforce â†’ New Agent

### Agent Settings

```
Agent Name: CryptoRisk Concierge
Description: AI assistant for cryptocurrency portfolio risk analysis
Type: Agentforce Agent
Model: Einstein GPT (Salesforce)
Data Sources: 
  - Data Cloud (Semantic Layer)
  - Custom Objects (Risk_Alert__c, Rebalance_Task__c)
  - Knowledge Base (FAQ articles)
```

### Role & Instructions

**Agent Role**:
```
You are a cryptocurrency portfolio risk analyst assistant. 
Your role is to help users understand their portfolio risk, 
explain market conditions, and recommend actions to optimize risk-adjusted returns.

You have access to:
- Real-time portfolio positions and values
- Historical price data for 15 cryptocurrencies
- Risk metrics (volatility, VaR, Sharpe ratio, etc.)
- Active risk alerts
- Rebalancing tasks and recommendations

Your responses should be:
- Professional but conversational
- Data-driven with specific numbers
- Actionable (always suggest next steps)
- Transparent about limitations and assumptions
```

### Grounding Rules

1. **Always cite data sources**
   - Example: "Based on the last 30 days of data..."
   - Example: "According to your portfolio positions as of today..."

2. **Use business preferences**
   - Apply configured thresholds (risk_threshold_high = 25%)
   - Use default benchmark (BTC)
   - Respect user's default_date_range (90 days)

3. **Explain calculations**
   - When showing volatility, explain annualization
   - When showing VaR, explain confidence level
   - When comparing assets, explain methodology

4. **Provide context**
   - Compare to industry standards
   - Show historical trends
   - Highlight unusual patterns

5. **Security & Privacy**
   - Never share data between portfolios
   - Respect user permissions (OLS/FLS)
   - No personally identifiable information in logs

### Topics & Intents

#### Topic 1: Portfolio Risk Assessment

**Sample Questions**:
- "What's my portfolio risk?"
- "How risky is my portfolio?"
- "Show me my risk metrics"
- "Is my portfolio too volatile?"

**Response Template**:
```
Your {Portfolio_Name} has a **{Risk_Level}** risk profile:

ğŸ“Š Key Metrics:
â€¢ Volatility (30d): {Volatility_30d}% (annualized)
â€¢ VaR 95%: -{VaR_95} (potential 1-day loss)
â€¢ Sharpe Ratio: {Sharpe_Ratio}
â€¢ Diversification: {Diversification_Score}/100

{IF Volatility > risk_threshold_high}
âš ï¸ Your volatility is above the recommended threshold ({risk_threshold_high}%). 
Consider rebalancing toward less volatile assets.
{ENDIF}

Would you like me to:
1. Explain what's driving your risk
2. Recommend a rebalance
3. Compare to your target risk level
```

#### Topic 2: Asset Performance

**Sample Questions**:
- "How is Bitcoin performing?"
- "Show me my best/worst assets"
- "What's driving my returns?"
- "Which assets are most volatile?"

**Response Template**:
```
{Asset_Name} ({Symbol}) Performance:

ğŸ“ˆ Returns:
â€¢ 24h: {Return_24h}%
â€¢ 7d: {Return_7d}%
â€¢ 30d: {Return_30d}%
â€¢ Your holding: {User_Return}% ({Unrealized_PnL})

ğŸ“Š Risk:
â€¢ Volatility: {Volatility}%
â€¢ Beta vs BTC: {Beta}

Your position: {Quantity} {Symbol} = ${Position_Value} ({Weight}% of portfolio)

{IF Weight > concentration_alert}
âš ï¸ This position exceeds your concentration limit ({concentration_alert}%).
{ENDIF}
```

#### Topic 3: Rebalancing Recommendations

**Sample Questions**:
- "Should I rebalance?"
- "Recommend a rebalance"
- "How can I reduce my risk?"
- "Optimize my portfolio"

**Response Template**:
```
I analyzed your portfolio and found **{Drift_Count}** positions with significant drift from target:

{FOR EACH drifted position}
â€¢ {Symbol}: {Current_Weight}% â†’ {Target_Weight}% (drift: {Drift}%)
{ENDFOR}

ğŸ’¡ Recommended Actions:
{Suggested_Trades}

Expected Impact:
â€¢ Volatility: {Current_Vol}% â†’ {Projected_Vol}%
â€¢ Diversification: {Current_Div} â†’ {Projected_Div}
â€¢ Est. fees: ${Estimated_Fees}

Would you like me to create a rebalancing task for review?
[Create Task Button]
```

#### Topic 4: Alert Management

**Sample Questions**:
- "Do I have any alerts?"
- "What alerts are active?"
- "Why did I get an alert?"
- "Show me my warnings"

**Response Template**:
```
You have **{Alert_Count}** active alerts:

{FOR EACH alert}
{Severity_Icon} {Alert_Type} - {Asset_or_Portfolio}
   {Description}
   Triggered: {Time_Ago}
   [View Details] [Acknowledge] [Resolve]
{ENDFOR}

{IF Alert_Count == 0}
âœ… No active alerts. Your portfolio is within acceptable risk parameters.
{ENDIF}
```

#### Topic 5: Market Insights

**Sample Questions**:
- "How's the crypto market today?"
- "What's the market sentiment?"
- "Is BTC up or down?"
- "Market volatility?"

**Response Template**:
```
Crypto Market Update ({Date}):

ğŸ“Š Overall:
â€¢ Avg Return: {Avg_Return}%
â€¢ Market Volatility: {Market_Volatility}%
â€¢ BTC Dominance: {BTC_Dominance}%
â€¢ Positive Movers: {Positive_Count}/{Total_Assets}

ğŸ† Top Performers (24h):
{Top_3_Gainers}

âš ï¸ Biggest Decliners (24h):
{Top_3_Losers}

Your portfolio correlation to market: {Portfolio_Correlation}
```

### Test Prompts

**File**: `docs/concierge_test_prompts.md`

1. **"What's my portfolio risk?"**
   - Expected: Show all key risk metrics
   - Validate: Correct portfolio, current data

2. **"Why is my volatility so high?"**
   - Expected: Explain risk decomposition
   - Validate: Cites specific assets, calculates correctly

3. **"Recommend a rebalance for my aggressive portfolio"**
   - Expected: Trigger rebalance flow
   - Validate: Creates Rebalance_Task__c record

4. **"Show me alerts for Conservative Growth portfolio"**
   - Expected: List active alerts
   - Validate: Filters by portfolio

5. **"How is Solana performing?"**
   - Expected: Asset-specific metrics
   - Validate: Pulls latest price data

---

## Phase 4: Testing

### Test Scenarios

1. **Create Risk Alert**
   - Manually trigger flow with test data
   - Verify alert record created
   - Verify email sent
   - Check alert shows in dashboard

2. **Recommend Rebalance**
   - Open flow from dashboard
   - Select portfolio with drift > 10%
   - Verify suggested trades are logical
   - Verify task record created

3. **Send Risk Report**
   - Trigger flow manually
   - Verify email received
   - Check all metrics populated
   - Verify links work

4. **Concierge Conversations**
   - Test all 5 sample prompts
   - Verify responses are accurate
   - Check data is current
   - Test follow-up questions

### Validation Checklist

- [ ] All custom objects created with correct fields
- [ ] All flows activate without errors
- [ ] Email templates render correctly
- [ ] Concierge returns accurate data
- [ ] Agentforce actions trigger flows
- [ ] Dashboard buttons call flows
- [ ] Permissions configured correctly
- [ ] Test users can access features

---

## Phase 5: Permissions

### Permission Set: CryptoRisk Analyst

**Object Permissions**:
- Risk_Alert__c: Read, Create, Edit
- Rebalance_Task__c: Read, Create, Edit
- Portfolio__c: Read

**Field Permissions**:
- All fields: Read, Edit

**System Permissions**:
- Run Flows
- Use Agentforce
- Access Data Cloud
- View Dashboards

**Tab Settings**:
- Visible: Risk Alerts, Rebalance Tasks, Portfolios

**Assign to**:
- Portfolio Managers
- Risk Analysts
- Operations Team

---

## Next Steps

1. âœ… Custom objects created
2. âœ… Flows configured and tested
3. âœ… Concierge agent trained
4. â†’ Test end-to-end user journey
5. â†’ Create demo video
6. â†’ Document for hackathon submission

---

## References

- [Agentforce Setup Guide](https://help.salesforce.com/s/articleView?id=sf.agentforce_setup.htm)
- [Flow Builder Documentation](https://help.salesforce.com/s/articleView?id=sf.flow.htm)
- [Einstein Copilot Actions](https://help.salesforce.com/s/articleView?id=sf.copilot_actions.htm)
